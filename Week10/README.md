# 10주차: [프로젝트] 고성능 멀티쓰레드 로거

"`std::cout`은 너무 느리고, 순서도 뒤죽박죽입니다."
이번 주에는 실무에서 필수적인 **비동기 로거(Async Logger)**를 직접 만들어봅니다. 지금까지 배운 내용을 총동원하는 미니 프로젝트입니다.

## 0. 미리 알면 좋은 용어 (Friendly Terms)
- **비동기 로깅 (Async Logging)**: "택배 맡기기"입니다. 로그를 직접 파일에 쓰지 않고, 큐(택배함)에 넣고 바로 돌아옵니다. 나중에 별도의 쓰레드(택배 기사)가 파일에 씁니다. 메인 쓰레드가 멈추지 않아서 빠릅니다.
- **Double Buffering (더블 버퍼링)**: "두 개의 바구니"입니다. 하나는 데이터를 담는 용도, 하나는 데이터를 비우는 용도로 씁니다. 꽉 차면 두 바구니를 서로 바꿉니다(Swap). 락을 거는 시간을 최소화하는 기법입니다.
- **Thread-Safe Queue**: "순서표 바구니"입니다. 여러 쓰레드가 동시에 접근해도 데이터가 꼬이지 않는 안전한 큐입니다.

## 1. 핵심 개념

### A. 동기(Sync) vs 비동기(Async) 로깅
- **동기 로깅**: `log("msg")`를 호출하면 파일에 다 쓸 때까지 리턴하지 않습니다. 디스크 I/O는 매우 느리기 때문에, 그동안 프로그램이 멈춥니다(Blocking).
- **비동기 로깅**: `log("msg")`를 호출하면 메모리 큐에 넣고 즉시 리턴합니다. 별도의 백그라운드 쓰레드가 큐에서 꺼내 파일에 씁니다.

### B. Double Buffering (더블 버퍼링)
- 매번 로그 하나 쓸 때마다 큐에 락을 걸고 풀면 오버헤드가 큽니다.
- **쓰기용 버퍼**와 **읽기용(파일 저장용) 버퍼**를 따로 둡니다.
- 쓰기용 버퍼가 꽉 차거나 일정 시간이 지나면, 두 버퍼를 통째로 교체(Swap)합니다.
- 파일에 쓰는 동안에는 락을 걸 필요가 없어서 성능이 비약적으로 상승합니다.

## 2. 자주 하는 실수 (Common Pitfalls)

> [!IMPORTANT]
> **1. 로거가 죽기 전에 프로그램 종료**
> 메인 함수가 끝나면 로거 쓰레드도 강제 종료될 수 있습니다.
> 큐에 아직 파일로 못 쓴 로그들이 남아있는데 그냥 죽으면 로그가 유실됩니다.
> -> **해결**: 소멸자에서 큐에 남은 로그를 다 파일에 쓰고(Flush) 죽도록 설계해야 합니다.

> [!TIP]
> **2. 포맷팅 비용**
> 로그 메시지를 문자열로 만드는(`sprintf`, `stringstream` 등) 비용도 만만치 않습니다.
> -> `std::format` (C++20)을 쓰면 좋지만, 컴파일러 지원 여부를 확인해야 합니다.

## 3. 실습 가이드
1. **01_sync_logger.cpp**: 동기 방식의 문제점(느림)을 직접 확인합니다.
2. **02_async_logger.cpp**: 7주차에 만든 `ThreadSafeQueue`를 활용해 비동기 로거를 구현합니다.
3. **03_logger_test.cpp**: 수십 개의 쓰레드에서 동시에 로그를 남겨보며 성능과 안정성을 테스트합니다.

## 4. Step-by-Step Guide
1. `build_cmake.bat`를 실행하여 빌드합니다.
2. `Debug/01_sync_logger.exe`를 실행하여 동기 로깅의 속도(느림)를 체감합니다.
3. `Debug/02_async_logger.exe`를 실행하여 비동기 로깅의 구조를 확인합니다.
4. `Debug/03_logger_test.exe`를 실행하여 다수 쓰레드에서의 성능과 안정성을 테스트합니다.

## 5. 빌드 및 실행
```powershell
.\build_cmake.bat
```

## 6. Diagram
```mermaid
graph LR
    App[Application Threads] -- Log Msg --> Q[Thread-Safe Queue]
    Q -- Dequeue --> Logger[Logger Thread]
    Logger -- Write --> File[Log File]
    style Q fill:#f9f,stroke:#333,stroke-width:2px
```
